volumes:
  ccache: # Optional ccache
  data: # Input data
  dist: # Installers

x-configuration: &CONFIGURATION
  volumes:
    - .:/srcML:ro
    - ccache:/ccache
    - data:/Data:ro
    - dist:/Builds
  working_dir: /srcML
  command: bash -c "${COMPOSE_COMMAND-cmake --workflow --preset $$WORKFLOW}"

x-platforms: &PLATFORMS
  platforms:
    - "linux/amd64"
    - "linux/arm64"

services:

  tar:
    image: alpine
    profiles: [utility]
    volumes:
        - dist:/dist
    command: tar --exclude=srcML.tar.gz -czf /dist/srcML.tar.gz -C /dist .

  clean:
    image: alpine
    profiles: [utility]
    volumes:
        - dist:/dist
    command: rm -fr /dist/*

  ubuntu_24.04:
    image: srcml/ubuntu:24.04
    platform: ${PLATFORM}
    profiles: [ubuntu, platform, latest]
    build:
      context: docker/ubuntu/
      tags:
        - "srcml/ubuntu:24.04"
      args:
        TAG: "24.04"
      <<: *PLATFORMS
    environment:
      - VERSION=${VERSION}
      - PRESET=deb
      - WORKFLOW=deb
    <<: *CONFIGURATION

  ubuntu_23.10:
    image: srcml/ubuntu:23.10
    platform: ${PLATFORM}
    profiles: [ubuntu, platform]
    build:
      context: docker/ubuntu/
      args:
        TAG: "23.10"
      <<: *PLATFORMS
    environment:
      - VERSION=${VERSION}
      - PRESET=deb
      - WORKFLOW=deb
    <<: *CONFIGURATION

  ubuntu_22.04:
    image: srcml/ubuntu:22.04
    platform: ${PLATFORM}
    profiles: [ubuntu, platform]
    build:
      context: docker/ubuntu/
      args:
        TAG: "22.04"
      <<: *PLATFORMS
    environment:
      # - PLATFORM=ubuntu_22.04
      - VERSION=${VERSION}
      - PRESET=deb
      - WORKFLOW=deb
    <<: *CONFIGURATION

  ubuntu_20.04:
    image: srcml/ubuntu:20.04
    platform: ${PLATFORM}
    profiles: [ubuntu, platform, earliest]
    build:
      context: docker/ubuntu/
      args:
        TAG: "20.04"
        CMAKE_BINARY: "ON"
      <<: *PLATFORMS
    environment:
      # - PLATFORM=ubuntu_20.04
      - VERSION=${VERSION}
      - PRESET=deb
      - WORKFLOW=deb
    <<: *CONFIGURATION

  fedora_41:
    image: srcml/fedora:41
    platform: ${PLATFORM}
    profiles: [fedora, platform, latest]
    build:
      context: docker/fedora/
      tags:
        - "srcml/fedora:latest"
      args:
        TAG: "41"
      <<: *PLATFORMS
    environment:
      # - PLATFORM=fedora_41
      - VERSION=${VERSION}
      - PRESET=rpm
      - WORKFLOW=rpm
    <<: *CONFIGURATION

  fedora_40:
    image: srcml/fedora:40
    platform: ${PLATFORM}
    profiles: [fedora, platform]
    build:
      context: docker/fedora/
      args:
        TAG: "40"
      <<: *PLATFORMS
    environment:
      # - PLATFORM=fedora_40
      - VERSION=${VERSION}
      - PRESET=rpm
      - WORKFLOW=rpm
    <<: *CONFIGURATION

  fedora_39:
    image: srcml/fedora:39
    platform: ${PLATFORM}
    profiles: [fedora, platform]
    build:
      context: docker/fedora/
      args:
        TAG: "39"
      <<: *PLATFORMS
    environment:
      # - PLATFORM=fedora_39
      - VERSION=${VERSION}
      - PRESET=rpm
      - WORKFLOW=rpm
    <<: *CONFIGURATION

  fedora_38:
    image: srcml/fedora:38
    platform: ${PLATFORM}
    profiles: [fedora, platform, earliest]
    build:
      context: docker/fedora/
      args:
        TAG: "38"
      <<: *PLATFORMS
    environment:
      # - PLATFORM=fedora_38
      - VERSION=${VERSION}
      - PRESET=rpm
      - WORKFLOW=rpm
    <<: *CONFIGURATION

  opensuse_15:
    image: srcml/opensuse:15
    platform: ${PLATFORM}
    profiles: [opensuse, platform]
    build:
      context: docker/opensuse/
      args:
        OPENSUSE: "leap"
        TAG: "15"
      <<: *PLATFORMS
    environment:
      # - PLATFORM=opensuse_15
      - VERSION=${VERSION}
      - PRESET=rpm
      - WORKFLOW=rpm
    <<: *CONFIGURATION

  opensuse_15.5:
    image: srcml/opensuse:15.5
    platform: ${PLATFORM}
    profiles: [opensuse, platform, latest]
    build:
      context: docker/opensuse/
      args:
        OPENSUSE: "leap"
        TAG: "15.5"
      <<: *PLATFORMS
    environment:
      # - PLATFORM=opensuse_15.5
      - VERSION=${VERSION}
      - PRESET=rpm
      - WORKFLOW=rpm
    <<: *CONFIGURATION

  opensuse_15.4:
    image: srcml/opensuse:15.4
    platform: ${PLATFORM}
    profiles: [opensuse, platform]
    build:
      context: docker/opensuse/
      args:
        OPENSUSE: "leap"
        TAG: "15.4"
      <<: *PLATFORMS
    environment:
      # - PLATFORM=opensuse_15.4
      - VERSION=${VERSION}
      - PRESET=rpm
      - WORKFLOW=rpm
    <<: *CONFIGURATION

  opensuse_15.3:
    image: srcml/opensuse:15.3
    platform: ${PLATFORM}
    profiles: [opensuse, platform]
    build:
      context: docker/opensuse/
      args:
        OPENSUSE: "leap"
        TAG: "15.3"
      <<: *PLATFORMS
    environment:
      # - PLATFORM=opensuse_15.3
      - VERSION=${VERSION}
      - PRESET=rpm
      - WORKFLOW=rpm
    <<: *CONFIGURATION

  opensuse_15.2:
    image: srcml/opensuse:15.2
    platform: ${PLATFORM}
    profiles: [opensuse, platform, earliest]
    build:
      context: docker/opensuse/
      args:
        OPENSUSE: "leap"
        TAG: "15.2"
      <<: *PLATFORMS
    environment:
      # - PLATFORM=opensuse_15.2
      - VERSION=${VERSION}
      - PRESET=rpm
      - WORKFLOW=rpm
    <<: *CONFIGURATION

  opensuse_tumbleweed:
    image: srcml/opensuse:tumbleweed
    platform: ${PLATFORM}
    profiles: [opensuse, platform]
    build:
      context: docker/opensuse/
      args:
        OPENSUSE: "tumbleweed"
        TAG: "latest"
      <<: *PLATFORMS
    environment:
      # - PLATFORM=opensuse_15.0
      - VERSION=${VERSION}
      - PRESET=rpm
      - WORKFLOW=rpm
    <<: *CONFIGURATION
